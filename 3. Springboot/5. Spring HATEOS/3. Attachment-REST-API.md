# Attachment lar (file, photo va boshqalar) ni database ga saqlash, ularni get qilish va REST API yaratish 

# 1. uuid
```sql
-- default holatda postgresql da uuid generate qiladigan extension mavjud bulmaydi
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```
---
# 2. Attachment Class
```java
package uz.pdp.spring_boot_demo.entity;

import jakarta.persistence.*;
import lombok.*;

import java.util.UUID;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
@Table(name = "attachments")
public class Attachment {

    @Id
    @Column(name = "id", updatable = false, nullable = false, columnDefinition = "uuid default uuid_generate_v4()")
    private UUID id;

    @Column(nullable = false, name = "original_name")
    private String originalName;

    @Column(nullable = false, name = "size")
    private Long size;

    @Column(nullable = false, name = "content_type")
    private String contentType;

    @Column(name = "file_name")
    private String fileName;

    @Column(name = "url")
    private String url;
}
```
---
# 3. AttachmentContent class
```java
package uz.kiut.de_kiut_uz.entity.attachment;

import jakarta.persistence.*;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@NoArgsConstructor
@Entity
@Table(name = "attachment_content")
public class AttachmentContent {

    @Id
    @Column(name = "id", updatable = false, nullable = false, columnDefinition = "uuid default uuid_generate_v4()")
    private UUID id;

    @Lob
    @Basic(fetch = FetchType.LAZY)
    @Column(nullable = false, name = "bytes")
    private byte[] bytes;

    @OneToOne(optional = false, fetch = FetchType.LAZY)
    @JoinColumn(name = "attachment_id", nullable = false, unique = true)
    private Attachment attachment;
}
```
---
# 4. AttachmentService
```java
public Attachment uploadFileOrFilesToDatabase(MultipartHttpServletRequest request) throws IOException {
        Iterator<String> fileNames = request.getFileNames();
        while (fileNames.hasNext()) {
            MultipartFile file = request.getFile(fileNames.next());
            if (file != null) {
                boolean existsByOriginalName = attachmentRepo.existsByOriginalName(file.getOriginalFilename());
                if (existsByOriginalName) {
                    return null;
                }
//                Attachment attachment = new Attachment(file.getOriginalFilename(), file.getSize(), file.getContentType(),createFileUrl(Objects.requireNonNull(file.getOriginalFilename())));
                Attachment savedAttachment = attachmentToFile(file);
                AttachmentContent attachmentContent = new AttachmentContent(file.getBytes(), savedAttachment);
                attachmentContentRepo.save(attachmentContent);
                return savedAttachment;
            }
        }

        return null;
    }


private String createFileUrl(String originalFilename) {
    String name = UUID.randomUUID().toString();
    String[] split = originalFilename.split("\\.");
    String contentType = split[split.length - 1];
    name = name + "." + contentType;
    return name;
}


public Attachment attachmentToFile(MultipartFile file) {
    return attachmentRepo.save(Attachment.builder()
            .originalName(file.getOriginalFilename())
            .fileName(createFileUrl(Objects.requireNonNull(file.getOriginalFilename())))
            .size((Long) file.getSize())
            .contentType(file.getContentType())
            .build());
}

public ApiResponse downloadFileByIdFromDb(String id, HttpServletResponse response) throws IOException {
        Optional<Attachment> optionalAttachment = attachmentRepo.findById(id);
        if (optionalAttachment.isPresent()) {
            Attachment attachment = optionalAttachment.get();
            Optional<AttachmentContent> optionalAttachmentContent = attachmentContentRepo.findByAttachmentId(id);
            if (optionalAttachmentContent.isPresent()) {
                AttachmentContent attachmentContent = optionalAttachmentContent.get();

                response.setHeader("Content-Disposition", "attachment; filename=\""
                        + attachment.getFileName() + "\"");
                response.setContentType(attachment.getContentType());
                FileCopyUtils.copy(attachmentContent.getBytes(), response.getOutputStream());
                return new ApiResponse(true, "Success");
            } else
                return new ApiResponse(false, "AttachmentContent not found!");
        }
        return new ApiResponse(false, "Attachment not found!");
    }
```

# 5. AttachmentController
```java
/**
 * Bitta file ni ham ko'p file larni ham database ga saqlovchi AttachmentService ni ichidagi methodga o'tvoradi.
 *
 * @param request MultipartHttpServletRequest
 * @return ApiResponse
 * @throws IOException exception
 */
@PostMapping("/upload")
public HttpEntity<?> uploadFileToDatabase(MultipartHttpServletRequest request) throws IOException {
    ApiResponse apiResponse = attachmentService.uploadFileOrFilesToDatabase(request);
    return ResponseEntity.status(apiResponse.isSuccess() ? 200 : 409).body(apiResponse);
}

@GetMapping("/download/{id}")
public HttpEntity<?> downloadFileByIdFromDatabase(@PathVariable String id, HttpServletResponse response) throws IOException {
    ApiResponse apiResponse = attachmentService.downloadFileByIdFromDb(id, response);
    return ResponseEntity.status(apiResponse.isSuccess() ? 200 : 409).body(apiResponse);
}
```
